<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png"/><link rel="manifest" href="/assets/site.webmanifest"/><link rel="mask-icon" href="/assets/safari-pinned-tab.svg" color="#5bbad5"/><link rel="shortcut icon" href="/assets/favicon.ico"/><meta name="msapplication-TileColor" content="#da532c"/><meta name="msapplication-config" content="/assets/browserconfig.xml"/><meta name="theme-color" content="#ffffff"/><link href="https://fonts.googleapis.com/css?family=Source+Serif+Pro:400,700&amp;display=swap" rel="stylesheet"/><title>Type narrowing and closures - prk3 blog</title><meta name="author" content="Przemysław Kukulski"/><meta name="keywords" content="typescript"/><meta name="description" content="Typescript offers a mechanism called type narrowing, which allows us to validate object&#x27;s type with type guards and avoid explicit casts or error silencing. This post will give a brief demo of this feature and show it&#x27;s interesting consequences."/><meta name="next-head-count" content="16"/><link rel="preload" href="/_next/static/css/21d4a735fb6b49f44edd.css" as="style"/><link rel="stylesheet" href="/_next/static/css/21d4a735fb6b49f44edd.css"/></head><body><div id="__next"><div class="Post"><header class="PostHeader"><picture class="PostHeaderImg"><source type="image/webp" media="(max-width:  480px)" srcSet="/assets/type-narrowing-and-closures/header-s-2x.webp   960w, /assets/type-narrowing-and-closures/header-s-1x.webp   480w"/><source type="image/webp" media="(max-width:  960px)" srcSet="/assets/type-narrowing-and-closures/header-m-2x.webp  1920w, /assets/type-narrowing-and-closures/header-m-1x.webp   960w"/><source type="image/webp" media="(max-width: 1440px)" srcSet="/assets/type-narrowing-and-closures/header-l-2x.webp  2880w, /assets/type-narrowing-and-closures/header-l-1x.webp  1440w"/><source type="image/webp" media="(max-width: 1920px)" srcSet="/assets/type-narrowing-and-closures/header-x-2x.webp  3840w, /assets/type-narrowing-and-closures/header-x-1x.webp  1920w"/><source type="image/webp" srcSet="/assets/type-narrowing-and-closures/header-xx-2x.webp 5120w, /assets/type-narrowing-and-closures/header-xx-1x.webp 2560w"/><source type="image/jpg" media="(max-width:  480px)" srcSet="/assets/type-narrowing-and-closures/header-s-2x.jpg   960w, /assets/type-narrowing-and-closures/header-s-1x.jpg   480w"/><source type="image/jpg" media="(max-width:  960px)" srcSet="/assets/type-narrowing-and-closures/header-m-2x.jpg  1920w, /assets/type-narrowing-and-closures/header-m-1x.jpg   960w"/><source type="image/jpg" media="(max-width: 1440px)" srcSet="/assets/type-narrowing-and-closures/header-l-2x.jpg  2880w, /assets/type-narrowing-and-closures/header-l-1x.jpg  1440w"/><source type="image/jpg" media="(max-width: 1920px)" srcSet="/assets/type-narrowing-and-closures/header-x-2x.jpg  3840w, /assets/type-narrowing-and-closures/header-x-1x.jpg  1920w"/><source type="image/jpg" srcSet="/assets/type-narrowing-and-closures/header-xx-2x.jpg 5120w, /assets/type-narrowing-and-closures/header-xx-1x.jpg 2560w"/><img class="PostHeaderImg__img" src="/assets/type-narrowing-and-closures/header-m-1x.jpg" alt="header image" style="color:#181f2b;background-color:#181f2b"/></picture><div class="PostHeader__navContainer"><div class="PostHeader__navColumn"><nav><a class="PostHeader__logo" href="/">prk3</a></nav></div></div><div class="PostHeader__titleContainer"><div class="PostHeader__titleColumn"><h1 class="PostHeader__title">Type narrowing and closures</h1><h2 class="PostHeader__author">Przemysław Kukulski</h2><h3 class="PostHeader__date"><time dateTime="Mon May 25 2020 02:00:00 GMT+0200 (Central European Summer Time)">May 25, 2020</time></h3><div class="PostHeader__tags"><a class="Tag Tag--light" style="background-color:#294e80" href="/tags/typescript">TypeScript</a></div></div></div></header><div class="Post__body"><div class="Post__bodyColumn fancy"><h1>Type narrowing</h1><p class="fancy__textFirstParagraph">If you&#x27;ve worked with Typescript before, chances are you&#x27;ve already came across type narrowing. Let&#x27;s consider a function that checks if a user has permissions for actions passed as an array of strings.</p><div class="Code"><pre style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">function</span> <span class="token" style="color:#DD4A68">canUser</span><span class="token" style="color:#999">(</span><span class="token parameter">user<span class="token" style="color:#999">:</span> <span class="token maybe-class-name">User</span><span class="token" style="color:#999">,</span> permissions<span class="token" style="color:#999">:</span> <span class="token" style="color:#690">string</span><span class="token" style="color:#999">[</span><span class="token" style="color:#999">]</span></span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">:</span> <span class="token" style="color:#690">boolean</span> <span class="token" style="color:#999">{</span>
    <span class="token" style="color:#07a">return</span> permissions<span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">every</span><span class="token" style="color:#999">(</span><span class="token parameter">permission</span> <span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span>
        user<span class="token" style="color:#999">.</span><span class="token property-access">permissions</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">includes</span><span class="token" style="color:#999">(</span>permission<span class="token" style="color:#999">)</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span>
<span class="token" style="color:#999">}</span>

<span class="token" style="color:#07a">if</span> <span class="token" style="color:#999">(</span><span class="token" style="color:#DD4A68">canUser</span><span class="token" style="color:#999">(</span>mike<span class="token" style="color:#999">,</span> <span class="token" style="color:#999">[</span><span class="token" style="color:#690">&#x27;todo.create&#x27;</span><span class="token" style="color:#999">,</span> <span class="token" style="color:#690">&#x27;todo.update&#x27;</span><span class="token" style="color:#999">]</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">)</span> <span class="token" style="color:#999">{</span>
    <span class="token" style="color:slategray">// ...</span>
<span class="token" style="color:#999">}</span>

<span class="token" style="color:#07a">if</span> <span class="token" style="color:#999">(</span><span class="token" style="color:#DD4A68">canUser</span><span class="token" style="color:#999">(</span>tom<span class="token" style="color:#999">,</span> <span class="token" style="color:#999">[</span><span class="token" style="color:#690">&#x27;piano.play&#x27;</span><span class="token" style="color:#999">]</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">)</span> <span class="token" style="color:#999">{</span>
    <span class="token" style="color:slategray">// ...</span>
<span class="token" style="color:#999">}</span></code></pre></div><p class="fancy__textFirstParagraph">Pretty simple. Let&#x27;s improve the API a bit. Passing a single string instead of an array with one element will save developers some typing.</p><div class="Code"><pre style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">function</span> <span class="token" style="color:#DD4A68">userCan</span><span class="token" style="color:#999">(</span>
    <span class="token parameter">user<span class="token" style="color:#999">:</span> <span class="token maybe-class-name">User</span><span class="token" style="color:#999">,</span>
    permissions<span class="token" style="color:#999">:</span> <span class="token" style="color:#690">string</span> <span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">|</span> <span class="token" style="color:#690">string</span><span class="token" style="color:#999">[</span><span class="token" style="color:#999">]</span></span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">:</span> <span class="token" style="color:#690">boolean</span> <span class="token" style="color:#999">{</span>

    <span class="token" style="color:#07a">if</span> <span class="token" style="color:#999">(</span><span class="token" style="color:#07a">typeof</span> permission <span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">===</span> <span class="token" style="color:#690">&#x27;string&#x27;</span><span class="token" style="color:#999">)</span> <span class="token" style="color:#999">{</span>
        <span class="token" style="color:slategray">// typescript knows that in this</span>
        <span class="token" style="color:slategray">// scope permission is a string</span>
        <span class="token" style="color:#07a">return</span> user<span class="token" style="color:#999">.</span><span class="token property-access">permissions</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">includes</span><span class="token" style="color:#999">(</span>permission<span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span>
    <span class="token" style="color:#999">}</span> <span class="token" style="color:#07a">else</span> <span class="token" style="color:#999">{</span>
        <span class="token" style="color:slategray">// in this scope permission can not be</span>
        <span class="token" style="color:slategray">// a string, so it&#x27;s an array</span>
        <span class="token" style="color:#07a">return</span> permissions<span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">every</span><span class="token" style="color:#999">(</span><span class="token parameter">permission</span> <span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span>
            user<span class="token" style="color:#999">.</span><span class="token property-access">permissions</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">includes</span><span class="token" style="color:#999">(</span>permission<span class="token" style="color:#999">)</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span>
    <span class="token" style="color:#999">}</span>
<span class="token" style="color:#999">}</span>

<span class="token" style="color:#07a">if</span> <span class="token" style="color:#999">(</span><span class="token" style="color:#DD4A68">userCan</span><span class="token" style="color:#999">(</span>ben<span class="token" style="color:#999">,</span> <span class="token" style="color:#690">&#x27;car.drive&#x27;</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">)</span> <span class="token" style="color:#999">{</span>
    <span class="token" style="color:slategray">// ...</span>
<span class="token" style="color:#999">}</span></code></pre></div><p class="fancy__textFirstParagraph">Type narrowing is occurring inside the if condition. In the first branch, the type <code>string | string[]</code> is narrowed to <code>string</code>. In else branch, Typescript assumes that the code will execute only if <code>permissions</code> is an array of strings.</p><p class="fancy__textFirstParagraph">Does <code>typeof</code> have special powers? No. <code>typeof</code> operator is a <strong>type guard</strong>. Its boolean result determines if a broader type (in this case union of two types) can be narrowed down. A function that you probably know by now - <code>Array.isArray</code> - is a type guard. We can define our own type guards too. Here is how they look like.</p><div class="Code"><pre style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">type</span> <span class="token maybe-class-name">CartesianPoint</span> <span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span> <span class="token" style="color:#999">{</span>
    x<span class="token" style="color:#999">:</span> <span class="token" style="color:#690">number</span><span class="token" style="color:#999">;</span>
    y<span class="token" style="color:#999">:</span> <span class="token" style="color:#690">number</span><span class="token" style="color:#999">;</span>
<span class="token" style="color:#999">}</span>

<span class="token" style="color:#07a">function</span> <span class="token" style="color:#DD4A68">isCartesianPoint</span><span class="token" style="color:#999">(</span><span class="token parameter">obj<span class="token" style="color:#999">:</span> <span class="token" style="color:#690">any</span></span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">:</span> obj <span class="token" style="color:#07a">is</span> <span class="token maybe-class-name">CartesianPoint</span> <span class="token" style="color:#999">{</span>
    <span class="token" style="color:#07a">return</span> <span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">!</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">!</span>obj <span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&amp;&amp;</span>
        <span class="token" style="color:#07a">typeof</span> obj <span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">===</span> <span class="token" style="color:#690">&#x27;object&#x27;</span> <span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&amp;&amp;</span>
        <span class="token" style="color:#07a">typeof</span> obj<span class="token" style="color:#999">.</span><span class="token property-access">x</span> <span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">===</span> <span class="token" style="color:#690">&#x27;number&#x27;</span> <span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&amp;&amp;</span>
        <span class="token" style="color:#07a">typeof</span> obj<span class="token" style="color:#999">.</span><span class="token property-access">y</span> <span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">===</span> <span class="token" style="color:#690">&#x27;number&#x27;</span><span class="token" style="color:#999">;</span>
<span class="token" style="color:#999">}</span>

<span class="token" style="color:#07a">function</span> <span class="token" style="color:#DD4A68">drawCartesianPoint</span><span class="token" style="color:#999">(</span><span class="token parameter">point<span class="token" style="color:#999">:</span> <span class="token maybe-class-name">CartesianPoint</span></span><span class="token" style="color:#999">)</span> <span class="token" style="color:#999">{</span>
    <span class="token" style="color:slategray">// draw on the screen</span>
<span class="token" style="color:#999">}</span>

<span class="token" style="color:#07a">function</span> <span class="token" style="color:#DD4A68">draw</span><span class="token" style="color:#999">(</span><span class="token parameter">obj<span class="token" style="color:#999">:</span> object</span><span class="token" style="color:#999">)</span> <span class="token" style="color:#999">{</span>

    <span class="token" style="color:slategray">// this will give a compile time error,</span>
    <span class="token" style="color:slategray">// because obj might not be a point</span>
    <span class="token" style="color:#DD4A68">drawCartesianPoint</span><span class="token" style="color:#999">(</span>obj<span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span>

    <span class="token" style="color:#07a">if</span> <span class="token" style="color:#999">(</span><span class="token" style="color:#DD4A68">isCartesianPoint</span><span class="token" style="color:#999">(</span>obj<span class="token" style="color:#999">)</span><span class="token" style="color:#999">)</span> <span class="token" style="color:#999">{</span>
        <span class="token" style="color:slategray">// this compiles, because type guard</span>
        <span class="token" style="color:slategray">// guarantees that the object is a point</span>
        <span class="token" style="color:#DD4A68">drawCartesianPoint</span><span class="token" style="color:#999">(</span>obj<span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span>
    <span class="token" style="color:#999">}</span>
<span class="token" style="color:#999">}</span></code></pre></div><p class="fancy__textFirstParagraph">If you want to read more about type guards, check out <a href="https://www.typescriptlang.org/docs/handbook/advanced-types.html#instanceof-type-guards">Typescript&#x27;s handbook</a>.</p><h1>Simple feature, huh?</h1><p class="fancy__textFirstParagraph">I recently run into a scenario that exposes a weird quirk of type narrowing. Take a look.</p><div class="Code"><pre style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">function</span> <span class="token" style="color:#DD4A68">access</span><span class="token" style="color:#999">(</span><span class="token parameter">index<span class="token" style="color:#999">:</span> <span class="token" style="color:#690">number</span><span class="token" style="color:#999">,</span> data<span class="token" style="color:#999">:</span> <span class="token" style="color:#690">any</span><span class="token" style="color:#999">[</span><span class="token" style="color:#999">]</span> <span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">|</span> <span class="token known-class-name" style="color:#DD4A68">Map</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token" style="color:#690">number</span><span class="token" style="color:#999">,</span> <span class="token" style="color:#690">any</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span></span><span class="token" style="color:#999">)</span> <span class="token" style="color:#999">{</span>
  <span class="token" style="color:#07a">let</span> indirection <span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span> data<span class="token" style="color:#999">;</span> <span class="token" style="color:slategray">// notice let</span>

  <span class="token" style="color:#07a">if</span> <span class="token" style="color:#999">(</span><span class="token known-class-name" style="color:#DD4A68">Array</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">isArray</span><span class="token" style="color:#999">(</span>indirection<span class="token" style="color:#999">)</span><span class="token" style="color:#999">)</span> <span class="token" style="color:#999">{</span>
    <span class="token" style="color:#07a">const</span> x <span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span> indirection<span class="token" style="color:#999">[</span>index<span class="token" style="color:#999">]</span><span class="token" style="color:#999">;</span>
    <span class="token" style="color:#07a">const</span> <span class="token function-variable" style="color:#DD4A68">y</span> <span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span> <span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span> <span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span> indirection<span class="token" style="color:#999">[</span>index<span class="token" style="color:#999">]</span><span class="token" style="color:#999">;</span> <span class="token" style="color:slategray">// error</span>
    <span class="token" style="color:#07a">const</span> z <span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span> <span class="token" style="color:#999">(</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span> <span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span> indirection<span class="token" style="color:#999">[</span>index<span class="token" style="color:#999">]</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span>
  <span class="token" style="color:#999">}</span>
<span class="token" style="color:#999">}</span></code></pre></div><p class="fancy__textFirstParagraph">The error message says:</p><blockquote><p class="fancy__textFirstParagraph">No index signature with a parameter of type &#x27;number&#x27; was found on type &#x27;any[] | Map&lt;number, any&gt;&#x27;.</p></blockquote><p class="fancy__textFirstParagraph">Wait, what? I though Typescript would narrow down <code>indirection</code> to array type. And it did it when initializing <code>x</code>. What&#x27;s wrong with <code>y</code>?</p><p class="fancy__textFirstParagraph">Type narrowing does not work when a <code>let</code> variable is captured by a function. Changing <code>let</code> to <code>const</code> fixes the error above. Seems weird at first glance, but it actually makes sense! Imagine that <strong>after</strong> creating function <code>y</code> we set variable <code>indirection</code> to a map and <strong>then</strong> call <code>y</code>.</p><div class="Code"><pre style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">function</span> <span class="token" style="color:#DD4A68">access</span><span class="token" style="color:#999">(</span><span class="token parameter">index<span class="token" style="color:#999">:</span> <span class="token" style="color:#690">number</span><span class="token" style="color:#999">,</span> data<span class="token" style="color:#999">:</span> <span class="token" style="color:#690">any</span><span class="token" style="color:#999">[</span><span class="token" style="color:#999">]</span> <span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">|</span> <span class="token known-class-name" style="color:#DD4A68">Map</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token" style="color:#690">number</span><span class="token" style="color:#999">,</span> <span class="token" style="color:#690">any</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span></span><span class="token" style="color:#999">)</span> <span class="token" style="color:#999">{</span>
  <span class="token" style="color:#07a">let</span> indirection <span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span> data<span class="token" style="color:#999">;</span> <span class="token" style="color:slategray">// notice let</span>

  <span class="token" style="color:#07a">if</span> <span class="token" style="color:#999">(</span><span class="token known-class-name" style="color:#DD4A68">Array</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">isArray</span><span class="token" style="color:#999">(</span>indirection<span class="token" style="color:#999">)</span><span class="token" style="color:#999">)</span> <span class="token" style="color:#999">{</span>
    <span class="token" style="color:#07a">const</span> <span class="token function-variable" style="color:#DD4A68">y</span> <span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span> <span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span> <span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span> indirection<span class="token" style="color:#999">[</span>index<span class="token" style="color:#999">]</span><span class="token" style="color:#999">;</span>
    indirection <span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span> <span class="token" style="color:#07a">new</span> <span class="token" style="color:#DD4A68">Map</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token" style="color:#690">number</span><span class="token" style="color:#999">,</span> <span class="token" style="color:#690">any</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span>
    <span class="token" style="color:#DD4A68">y</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span> <span class="token" style="color:slategray">// ?</span>
  <span class="token" style="color:#999">}</span>
<span class="token" style="color:#999">}</span></code></pre></div><p class="fancy__textFirstParagraph">The call to <code>y</code> yields <code>undefined</code> because one line above <code>indirection</code> reference was set to a map, which does not have numerical properties. If <code>indirection</code> was declared with <code>const</code>, reassignment would not be allowed and thus the array guarantee would be always valid.</p><p class="fancy__textFirstParagraph">It&#x27;s fascinating how Typescript tracks type changes. The difference in behavior between <code>let</code> and <code>cost</code> captured variables reminds me of Rust&#x27;s borrow checker. <code>y</code> borrows <code>indirection</code>, which should not be changed until <code>y</code> is destroyed. Otherwise, the array invariant is broken. Interestingly, an IIFE assigned to <code>z</code> in the previous example does not trigger that error. Maybe Typescript noticed that the borrow immediately disappears and type may stay unchanged?</p></div></div><footer class="PostFooter"><div class="PostFooter__column"><h1 class="PostFooter__title">Thanks for reading!</h1><p class="PostFooter__message"><span>Want to ask a question or discuss the topic? Found a mistake?</span><br/><span>Open a </span><a class="link--clean" href="https://github.com/prk3/blog-source/issues">github issue</a><span>!</span></p><nav class="PostFooter__nav"><div class="PostFooter__next"><div class="PostRef PostRef--left"><a class="PostRef__link" href="/posts/functional-tetris"><div class="PostRef__label">Next post</div><h6 class="PostRef__title">Tetris in functional style</h6><div class="PostRef__arrow">❮</div></a></div></div><div class="PostFooter__back"><a class="PostFooter__backLink" href="/">Home</a></div><div class="PostFooter__prev"><div class="PostRef PostRef--right"><a class="PostRef__link" href="/posts/a-static-blog"><div class="PostRef__label">Previous post</div><h6 class="PostRef__title">A static blog?</h6><div class="PostRef__arrow">❯</div></a></div></div></nav></div></footer></div></div></body></html>